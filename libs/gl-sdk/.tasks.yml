version: "3"

vars:
  PROFILE: '{{.PROFILE | default "release"}}'
  PROFILE_DIR: '{{if eq .PROFILE "release"}}release{{else}}debug{{end}}'
  CARGO_FLAGS: '{{if eq .PROFILE "release"}}--release{{else}}{{end}}'
  LIB_EXT:
    sh: |
      case "$(uname -s)" in
        Darwin*)
          echo "dylib"
          ;;
        MINGW*|MSYS*|CYGWIN*) 
          echo "dll"
          ;;
        *)
          echo "so"
          ;;
      esac

tasks:
  build:
    desc: "Build the gl-sdk library"
    dir: "{{.TASKFILE_DIR}}/../.."
    cmds:
      - cargo build -p gl-sdk {{.CARGO_FLAGS}}

  build-release:
    desc: "Build the gl-sdk library in release mode"
    dir: "{{.TASKFILE_DIR}}"
    cmds:
      - task: build
        vars: { PROFILE: "release" }

  bindings-python:
    desc: "Generate Python bindings"
    dir: "{{.TASKFILE_DIR}}/../.."
    deps:
      - build
    cmds:
      - |
        cp ${CARGO_TARGET_DIR:-target}/{{.PROFILE_DIR}}/libglsdk.{{.LIB_EXT}} ./libs/gl-sdk/glsdk/libglsdk.{{.LIB_EXT}};
        cargo run --bin uniffi-bindgen -- generate \
          --library ${CARGO_TARGET_DIR:-target}/{{.PROFILE_DIR}}/libglsdk.{{.LIB_EXT}} \
          --language python \
          --out-dir ./libs/gl-sdk/glsdk

  bindings-kotlin:
    desc: "Generate Kotlin bindings"
    dir: "{{.TASKFILE_DIR}}/../.."
    deps:
      - build
    cmds:
      - |
        cp ${CARGO_TARGET_DIR:-target}/{{.PROFILE_DIR}}/libglsdk.{{.LIB_EXT}} ./libs/gl-sdk/glsdk/libglsdk.{{.LIB_EXT}};
        cargo run --bin uniffi-bindgen -- generate \
          --library ${CARGO_TARGET_DIR:-target}/{{.PROFILE_DIR}}/libglsdk.{{.LIB_EXT}} \
          --language kotlin \
          --out-dir ./libs/gl-sdk/bindings

  bindings-swift:
    desc: "Generate Swift bindings"
    dir: "{{.TASKFILE_DIR}}/../.."
    deps:
      - build
    cmds:
      - |
        cp ${CARGO_TARGET_DIR:-target}/{{.PROFILE_DIR}}/libglsdk.{{.LIB_EXT}} ./libs/gl-sdk/glsdk/libglsdk.{{.LIB_EXT}};
        cargo run --bin uniffi-bindgen -- generate \
          --library ${CARGO_TARGET_DIR:-target}/{{.PROFILE_DIR}}/libglsdk.{{.LIB_EXT}} \
          --language swift \
          --out-dir ./libs/gl-sdk/bindings

  bindings-ruby:
    desc: "Generate Ruby bindings"
    dir: "{{.TASKFILE_DIR}}/../.."
    deps:
      - build
    cmds:
      - |
        cp ${CARGO_TARGET_DIR:-target}/{{.PROFILE_DIR}}/libglsdk.{{.LIB_EXT}} ./libs/gl-sdk/glsdk/libglsdk.{{.LIB_EXT}};
        cargo run --bin uniffi-bindgen -- generate \
          --library ${CARGO_TARGET_DIR:-target}/{{.PROFILE_DIR}}/libglsdk.{{.LIB_EXT}} \
          --language ruby \
          --out-dir ./libs/gl-sdk/bindings

  bindings-typescript:
    desc: "Generate Typescript bindings"
    dir: "{{.TASKFILE_DIR}}/../gl-sdk-napi"
    deps:
      - build
    cmds:
      - |
        npm install
        npm run build

  bindings-all:
    desc: "Generate all language bindings"
    dir: "{{.TASKFILE_DIR}}/../.."
    deps:
      - bindings-python
      - bindings-kotlin
      - bindings-swift
      - bindings-ruby
      - bindings-typescript

  package-python:
    desc: "Build Python wheel package"
    dir: "{{.TASKFILE_DIR}}"
    cmds:
      - task: build
      - task: bindings-python
      - uv build

  install-python:
    desc: "Install Python package in development mode"
    dir: "{{.TASKFILE_DIR}}"
    cmds:
      - task: package-python
      - uv sync

  prepare-test:
    desc: "Prepare test environment by copying bindings to package"
    dir: "{{.TASKFILE_DIR}}"
    cmds:
      - task: bindings-python
      - task: install-python
  test:
    desc: "Run gl-sdk tests (loads library from source)"
    dir: "{{.TASKFILE_DIR}}"
    deps:
      - prepare-test
    cmds:
      - uv run pytest tests -v

  clean:
    desc: "Clean generated bindings and build artifacts"
    dir: "{{.TASKFILE_DIR}}"
    cmds:
      - rm -rf ./bindings
      - rm -rf dist/ build/ *.egg-info
      - rm -f glsdk/*.{{.LIB_EXT}} glsdk/glsdk.py
      - find . -type d -name __pycache__ -exec rm -rf {} + 2>/dev/null || true
      - find . -type f -name "*.pyc" -delete