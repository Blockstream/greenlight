version: '3'

env:
  CARGO_TARGET_DIR: /tmp/target
  GL_BINDING_LIB: $CARGO_TARGET_DIR/release/libglbindings.so
  BINDGEN_BIN: 

tasks:
  bindgen:
    dir: '.'
    cmds:
      - cargo build --release
      
  build:
    dif: '.'
    deps:
      - build-python

  build-python:
    cmds:
      - task: bindgen
      - pwd
      - cd ../tools/uniffi-bindgen/; cargo build --release
      - mkdir -p python/glclient
      - cp "$CARGO_TARGET_DIR/release/libglbindings.so" python/glclient
      # Run the `uniffi-bindgen` with `uv` so it has access to `yapf`
      # and other tooling that is managed by `uv`
      - uv run $CARGO_TARGET_DIR/release/uniffi-bindgen generate --language python --out-dir python/glclient --library "python/glclient/libglbindings.so"
      - echo 'from .glclient import *' > python/glclient/__init__.py

  test-python:
    deps:
      - build-python
    cmds:
      - PYTHONPATH=python python3 -c 'import glclient;n=glclient.Node();print(n);'

  all:
    deps:
      - test-python
