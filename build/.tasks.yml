version: "3"

tasks:
  android:
    deps:
      - linux-android-aarch64
      - linux-androideabi-armv7
      - linux-android-i686
      - linux-android-x86_64
    cmds:
      - cp -a target/release/android/jniLibs libs/gl-sdk-android/lib/src/androidMain
      
  kotlin:
    deps:
      - android
    vars:
      OS_NAME:
        sh: uname | tr '[:upper:]' '[:lower:]'
    cmds:
      - cargo install --bin gobley-uniffi-bindgen gobley-uniffi-bindgen@0.3.7
      - gobley-uniffi-bindgen --config ./libs/gl-sdk/uniffi.kotlin-multiplatform.toml --library ./target/aarch64-linux-android/debug/libglsdk.a --out-dir target/release/kotlin-multiplatform
      - cp -a ./target/release/kotlin-multiplatform/* libs/gl-sdk-android/lib/src/
      - cp -a {{.ANDROID_NDK_HOME}}/toolchains/llvm/prebuilt/{{.OS_NAME}}-x86_64/sysroot/usr/lib/aarch64-linux-android/libc++_shared.so libs/gl-sdk-android/lib/src/androidMain/jniLibs/arm64-v8a/
      - cp -a {{.ANDROID_NDK_HOME}}/toolchains/llvm/prebuilt/{{.OS_NAME}}-x86_64/sysroot/usr/lib/arm-linux-androideabi/libc++_shared.so libs/gl-sdk-android/lib/src/androidMain/jniLibs/armeabi-v7a/
      - cp -a {{.ANDROID_NDK_HOME}}/toolchains/llvm/prebuilt/{{.OS_NAME}}-x86_64/sysroot/usr/lib/i686-linux-android/libc++_shared.so libs/gl-sdk-android/lib/src/androidMain/jniLibs/x86/
      - cp -a {{.ANDROID_NDK_HOME}}/toolchains/llvm/prebuilt/{{.OS_NAME}}-x86_64/sysroot/usr/lib/x86_64-linux-android/libc++_shared.so libs/gl-sdk-android/lib/src/androidMain/jniLibs/x86_64/

  swift:
    deps:
      - ios
      - ios-sim
    cmds:
      - cargo run --features bindings -- generate --library ./target/aarch64-apple-ios/release/libglsdk.a --language swift --out-dir ./target/swift
      - mkdir -p ./target/swift/include
      - mv target/swift/glsdkFFI.h target/swift/include
      - mv target/swift/glsdkFFI.modulemap  target/swift/include/module.modulemap
      - xcodebuild -create-xcframework -library target/lipo-ios-sim/release/libglsdk.a -headers target/swift/include -library target/aarch64-apple-ios/release/libglsdk.a -headers target/swift/include -output target/glsdkFFI.xcframework

  linux-*-*:
    vars:
      ABI: '{{index .MATCH 0}}'
      ARCH: '{{index .MATCH 1}}'
    cmds:
      - cargo ndk -t {{.ARCH}}-linux-{{.ABI}} -o target/release/android/jniLibs build -p gl-sdk

  ios:
    deps:
      - ios-apple-aarch64
      - ios-apple-x86_64

  ios-sim:
    deps:
      - ios-sim-apple-aarch64
      
  ios-apple-*:
    vars:
      ARCH: '{{ index .MATCH 0 }}'
    cmds:
      - IPHONEOS_DEPLOYMENT_TARGET=12.0 MACOSX_DEPLOYMENT_TARGET=11.0 cargo build --release --target {{.ARCH}}-apple-ios -p gl-sdk

  ios-sim-apple-*:
    vars:
      ARCH: '{{ index .MATCH 0 }}'
    cmds:
      - IPHONEOS_DEPLOYMENT_TARGET=12.0 MACOSX_DEPLOYMENT_TARGET=11.0 cargo build --release --target {{.ARCH}}-apple-ios-sim -p gl-sdk
